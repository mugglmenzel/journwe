@(adv: models.adventure.Adventure, timeForm: Form[models.adventure.time.TimeOption])

@import models.adventure.time.TimeOption
@import models.dao.TimeOptionDAO

@import helper._
@import fieldConstructor._

@implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.render) }


<table id="times-list" class="table table-striped table-hover hide">
    <thead>
    <tr>
        <th>Your Vote</th>
        <th>Time Option</th>
        <th class="text-center">YES</th>
        <th class="text-center">MAYBE</th>
        <th class="text-center">NO</th>
        <th>Adventurers' Votes</th>
        <th class="text-center">Actions</th>
    </tr>
    </thead>
    <tbody>

    </tbody>
</table>


<div class="times-loading"><i class="icon-spin icon-spinner"></i> Loading</div>

<div id="time-add-form" class="inline input-append">

        <input type="text" name="name" placeholder="Name of Option" required="required" style="width: 250px;"/>
        <div class="input-prepend">
            <span class="add-on">Start Date</span>
            <input class="journwe-date" data-date="2014-03-14" data-date-format="yyyy-mm-dd" type="date" name="startDate" placeholder="Start Date" style="max-width: 150px;" required="required"/>
        </div>
        <div class="input-prepend">
            <span class="add-on">End Date</span>
            <input class="journwe-date" data-date="2014-03-16" data-date-format="yyyy-mm-dd" type="date" name="endDate" placeholder="End Date" style="max-width: 150px;" required="required"/>
        </div>

        <button id="time-add-button" class="btn"><i class="icon-plus"></i></button>

</div>


    <script type="text/x-tmpl" id="time-template">
        <tr id="timeoption-item-{%=o.id%}">
            <td>
                <div class="btn-group">
                    <button id="timeoption-status-{%=o.id%}" class="btn" style="width: 90px"><i id="timeoption-status-icon-{%=o.id%}"></i> {%=o.vote%}</button>
                    <button class="btn dropdown-toggle" data-toggle="dropdown">
                        <i class="icon-pencil"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a onclick="voteTime('YES', '{%=o.id%}');"><i class="icon-thumbs-up"></i> Yes</a></li>
                        <li><a onclick="voteTime('MAYBE', '{%=o.id%}');"><i class="icon-question"></i> Maybe</a></li>
                        <li><a onclick="voteTime('NO', '{%=o.id%}');"><i class="icon-thumbs-down"></i> No</a></li>
                    </ul>
                </div>
            </td>
                <!--<td>{%=o.name%}</td>-->
            <td>{%=o.name%}: {%=formatDate(o.startDate)%} to {%=formatDate(o.endDate)%} </td>
            <td class="text-center">{%=o.voteCount.YES%}</td>
            <td class="text-center">{%=o.voteCount.MAYBE%}</td>
            <td class="text-center">{%=o.voteCount.NO%}</td>
            <td>{% for (var i in o.voteAdventurers) { for (var j in o.voteAdventurers[i]) { %} <span class="label {%=voteTimeLabelCSSClassMap[i]%}" title="{%=o.voteAdventurers[i][j]%}">{%=o.voteAdventurers[i][j].split(/\s/)[0]%}</span> {% }} %}</td>
            <td class="text-center"><a onclick="deleteTime('{%=o.id%}', this);" class="btn btn-danger"><i class="icon-trash"></i></a></td>
            {%



            %}
        </tr>
    </script>

    <script>
        $(".journwe-date").datepicker();

        $('#time-add-button').on('click', function() {
        $(this).html('<i class="icon-spin icon-spinner"></i>');
        $.post('@routes.AdventureTimeController.addTime(adv.getId)', { name: $('#time-add-form input[name=name]').val(), startDate: $('#time-add-form input[name=startDate]').val(), endDate: $('#time-add-form input[name=endDate]').val()}, function(res) {
        renderTimeOption(res);
        $('#time-add-form input[name=name]').val("");
        $('#time-add-form input[name=startDate]').val("");
        $('#time-add-form input[name=endDate]').val("");
        $('#time-add-button').html('<i class="icon-plus"></i>');
        $('#times-list').show();
        });
        });

        $('#times-list').ready(function (){
        $.get('@routes.AdventureTimeController.getTimes(adv.getId)', function (times) {
        $('#times-list tbody').empty();
        for(var id in times) {
            renderTimeOption(times[id])
        }
        if (times.length){
            $('#times-list').show();
        } else {
            $('#times-list').hide();
        }

        $('.times-loading').hide();
        });
        });

        function renderTimeOption(data, replace) {
        if(replace)
            replace.replaceWith(tmpl('time-template', data)).fadeIn();
        else
            $('#times-list tbody').append(tmpl('time-template', data));


        $('#timeoption-status-icon-' + data.id).addClass(voteTimeIconCSSClassMap[data.vote]);
        $('#timeoption-status-' + data.id).addClass(voteTimeButtonCSSClassMap[data.vote]);
        }


        var voteTimeIconCSSClassMap = {'YES': 'icon-thumbs-up', 'NO': 'icon-thumbs-down', 'MAYBE': 'icon-question'};
        var voteTimeButtonCSSClassMap = {'YES': 'btn-success', 'NO': 'btn-danger', 'MAYBE': 'btn-warning'};
        var voteTimeLabelCSSClassMap = {'YES': 'label-success', 'NO': 'label-important', 'MAYBE': 'label-warning'};

        function voteTime(vote, optId) {

        $('#timeoption-item-'+optId+' .dropdown-toggle')
            .html('<i class="icon-spin icon-spinner"></i>');
        $.ajax({
        url: '@routes.AdventureTimeController.vote("")' + optId,
        data: {
        vote: vote
        },
        type: 'PUT',
        success: function(res) {
            renderTimeOption(res, $('#timeoption-item-' + res.id));
            $('#timeoption-item-'+res.id+' .dropdown-toggle')
                .html('<i class="icon-pencil"></i>');
        }
        });
        }

        function deleteTime(optId, el) {
        $(el).html('<i class="icon-spin icon-spinner"></i>');
        $.ajax({url: '@routes.AdventureTimeController.deleteTime("")' + optId, type: 'DELETE', success: function () {
            $('#timeoption-item-' + optId).fadeOut(function () {$('#timeoption-item-' + optId).remove();});
        }
        });
        }

</script>