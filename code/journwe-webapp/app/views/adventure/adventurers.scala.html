@(adv: models.adventure.Adventure, advr: models.adventure.Adventurer)

@import models.adventure.EAdventurerParticipation
@import models.dao.AdventurerDAO
@import models.dao.UserDAO


@cssForStatus(status:EAdventurerParticipation) = {
@status match {
case EAdventurerParticipation.NOTGOING => {error}
case EAdventurerParticipation.UNDECIDED => {warning}
case EAdventurerParticipation.GOING => {info}
case EAdventurerParticipation.BOOKED => {success}
case EAdventurerParticipation.APPLICANT => {}
}
}


@defining((advr.getParticipationStatus())) { (status) =>

@if(status != null && !EAdventurerParticipation.APPLICANT.equals(status)){
<div>
    <strong style="vertical-align:middle;">You are... </strong>

    <div class="btn-group btn-select-adventurer">
        <a class="btn btn-danger @if(status == EAdventurerParticipation.NOTGOING){active}"
           href="@routes.AdventurePeopleController.participateStatus(adv.getId(), EAdventurerParticipation.NOTGOING.name())"><i class="icon-frown"></i> Not
            In</a>
        <a class="btn btn-warning @if(status == EAdventurerParticipation.UNDECIDED){active}"
           href="@routes.AdventurePeopleController.participateStatus(adv.getId(), EAdventurerParticipation.UNDECIDED.name())"><i class="icon-question"></i> Undecided</a>
        <a class="btn btn-primary @if(status == EAdventurerParticipation.GOING){active}"
           href="@routes.AdventurePeopleController.participateStatus(adv.getId(), EAdventurerParticipation.GOING.name())"><i class="icon-smile"></i> So In</a>
        <a class="btn btn-success @if(status == EAdventurerParticipation.BOOKED){active}"
           href="@routes.AdventurePeopleController.participateStatus(adv.getId(), EAdventurerParticipation.BOOKED.name())"><i class="icon-ok"></i> Booked</a>
    </div>
</div>
} else {
@if(EAdventurerParticipation.APPLICANT.equals(status)) {
<div>
    <strong>You are an Applicant.</strong>
</div>
} else {
<div>
    <a class="btn btn-primary" href="@routes.AdventurePeopleController.participate(adv.getId())">Participate</a>
</div>
}
}


<table class="table table-striped table-hover table-adventurers">

    <thead>
    <tr>
        <th style="width: 100%;">Name</th>
        <th class="text-center">Status</th>
    </tr>
    </thead>
    <tbody>
    @{new
    AdventurerDAO().all(adv.getId()).filter(!_.getParticipationStatus().equals(EAdventurerParticipation.APPLICANT)).map{
    advr =>
    <tr class={cssForStatus(advr.getParticipationStatus()).toString} id={"adventurer-state-"+advr.getUserId()}>
        <td>{new UserDAO().get(advr.getUserId()).getName()}</td>
        <td class="text-center">{advr.getParticipationStatus()}</td>
    </tr>
    }}
    </tbody>
</table>
@defining(new AdventurerDAO().all(adv.getId())) { applicants =>
@if(applicants != null && applicants.size() >= 0) {

<div class="spacer30"></div>
<table class="table table-striped table-hover">
    <thead>
    <tr>
        <th style="width: 100%;">Applicants</th>
        <th class="text-center">Status</th>
        <th class="text-center">Adopt</th>
    </tr>
    </thead>
    <tbody>
    @{applicants.filter(_.getParticipationStatus().equals(EAdventurerParticipation.APPLICANT)).map{
    appl =>
    <tr class={cssForStatus(appl.getParticipationStatus()).toString}>
        <td>{new UserDAO().get(appl.getUserId()).getName()}</td>
        <td class="text-center">{appl.getParticipationStatus()}</td>
        <td class="text-center">{if(!status.equals(EAdventurerParticipation.APPLICANT)){
                <a class="btn btn-primary btn-adopt"
                    href={routes.AdventurePeopleController.adopt(adv.getId(),appl.getUserId()).toString()}>Adopt</a>
            }}
        </td>
    </tr>
    }}
    </tbody>
</table>


<script>

    $(function(){

        var conf = {
            '@EAdventurerParticipation.NOTGOING' : 'error',
            '@EAdventurerParticipation.UNDECIDED' : 'warning',
            '@EAdventurerParticipation.GOING' : 'info',
            '@EAdventurerParticipation.BOOKED' : 'success'
        };

        $('.btn-select-adventurer a').click(function(){
            var el = $(this),
                html = el.html();
            
            el.css({width:el.width()+"px"})
                .html('<i class="icon-spin icon-spinner"></i>');

            $.post(el.attr('href'), function(json){
                var state = json.participationStatus;

                el.css({width:""})
                    .html(html);

                el.parent().find('.active').removeClass('active');
                el.addClass('active');

                $('#adventurer-state-'+json.userId)
                    .attr('class', conf[state])
                    .find('td:last-child').html(state);
            });
            return false;
        });


        $('.btn-adopt').click(function(){
            var el = $(this),
                html = el.html();
            
            el.css({width:el.width()+"px"})
                .html('<i class="icon-spin icon-spinner"></i>');

            $.post(el.attr('href'), function(json){
                var state = json.participationStatus;

                el.css({width:""})
                    .html(html);

                el.parents('tr').fadeOut(function(){
                    if ($(this).parent().find('tr').lenght <= 1){
                        $(this).parents('table').remove();
                    } else {
                        $(this).remove();
                    }
                });

                $('.table-adventurers tbody').append('<tr class="'+conf[state]+'"><td>'+(json.userName||json.userId)+'</td><td class="text-center">'+state+'</td></tr>');

            });
            return false;
        });
    });

</script>

}
}
}