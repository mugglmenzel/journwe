@(adv: models.adventure.Adventure, advr: models.adventure.Adventurer)

@import models.dao.TodoDAO
@import models.dao.UserDAO
@import models.adventure.checklist.EStatus


@defining(advr.getUserId()) { user =>
@defining(new TodoDAO().allByUser(adv.getId())) { list =>
<table class="table table-striped table-hover table-my-todos">
    <thead>
    <tr>
        <th>Things to do</th>
        <th style="width:100%;"></th>
        <th class="text-center">Actions</th>
    </tr>
    </thead>
    <tbody>
    @if(list.containsKey(user)){
    @for(todo <- list.get(user)) {
    <tr class="status-@todo.getStatus() todo-entry" data-id="@todo.getId()">
        <td>
            <input type="checkbox" class="input-status" @if(todo.getStatus()==EStatus.COMPLETE){checked}/>
        </td>
        <td>@todo.getTitle()</td>
        <td class="text-center"><a href="#" class="btn btn-danger btn-delete"><i class="icon-trash"></i></td>
    </tr>
    }
    }
    </tbody>
</table>


<div class="input-append">
    <input id="todo-title" type="text" placeholder="Add an important thing"/>
    <button id="btn-add-todo" class="btn" type="button"><i class="icon-plus"></i></button>
</div>

<div class="spacer30"></div>

@for(usr <- list.keySet()) {
@if(usr != user){
<h3>Packing List for @{new UserDAO().get(usr).getName()}</h3>
<table class="table table-striped table-hover">
    <thead>
    <tr>
        <th>Things to do</th>
        <th></th>
        <th class="text-center"></th>
    </tr>
    </thead>
    <tbody>
    @for(todo <- list.get(usr)) {
    <tr>
        <td><input type="checkbox" disabled="true" @if(todo.getStatus()==EStatus.COMPLETE){checked}/></td>
        <td>@todo.getTitle()</td>
        <td class="text-center"><a href="#" class="btn btn-copy" title="Copy todo to my list."><i class="icon-plus"></i></a></td>
    </tr>
    }
    </tbody>
</table>
}
}

<script type="text/javascript">
    $(function() {

    $('#todo-title').on('keydown', function(e){
        if (e.keyCode==13){
            $('#btn-add-todo').click();
        }
    });

    $('#btn-add-todo').on('click', function() {
    $(this).html('<i class="icon-spin icon-spinner"></i>');
    var btn = $(this),
    fld = $('#todo-title');

    $.post('@routes.AdventureTodoController.addTodo(adv.getId)', { title: fld.val() }, function(res) { $('.table-my-todos  tbody') .append($('<tr class="status-' + res.status + ' todo-entry" data-id="' + res.id + '">  <td><input class="input-status"  type="checkbox"/></td><td>' + res.title + '</td><td class="text-center"><a href="#" class="btn btn-danger btn-delete"><i class="icon-trash"></i></a></td> </tr>').fadeIn());
        fld.val("");
        $('#btn-add-todo').html('<i class="icon-plus"></i>')
    });
    });


    $('table.table-my-todos').on('click', 'input.input-status', function() {

    var input = $(this),
    tr = input.parents('.todo-entry'),
    id = tr.attr('data-id');

    $.ajax({
    url: '@routes.AdventureTodoController.setTodo(adv.getId(), "")' + id,
    data: {
    status: input.is(':checked') ? "COMPLETE" : "NEW"
    },
    type: 'PUT',
    success: function(res) {
    tr.get(0).className = 'status-' + res.status + ' todo-entry';
    }
    });
    });

    $('table.table-my-todos').on('click', 'a.btn-delete', function(e) {
    $(this).html('<i class="icon-spin icon-spinner"></i>');
    e.preventDefault();

    var a = $(this),
    tr = a.parents('.todo-entry'),
    id = tr.attr('data-id');

    $.ajax({
    url: '@routes.AdventureTodoController.deleteTodo(adv.getId(), "")' + id,
    type: 'DELETE',
    success: function(res) {
    tr.fadeOut(function() {
    tr.remove();
    });
    }
    });

    });

    $('.btn-copy')
    .on('click', function(e) {
    e.preventDefault();

    var btn = $(this),
    tr = btn.parents('tr'),
    td = tr.find('td'),
    title = $(td[1]).text();

    $.post('@routes.AdventureTodoController.addTodo(adv.getId)', {
    title: title
    }, function(res) {
    $('.table-my-todos tbody').append($('<tr class="status-' + res.status + ' todo-entry" data-id="' + res.id + '"><td><input class="input-status" type="checkbox"/></td><td>' + res.title + '</td><td><a href="#" class="btn-delete"><i class="icon-trash"></i>Delete</a></td></tr>').fadeIn());
    });
    });


    });


</script>

}
}